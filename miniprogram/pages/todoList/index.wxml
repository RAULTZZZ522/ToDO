<view class="container">
  <view class="header">
    <view class="title">æˆ‘çš„æ—¥ç¨‹</view>
    <view class="sort-controls">
      <view class="sort-btn {{sortBy === 'updateTime' ? 'active' : ''}}" bindtap="toggleSort" data-type="updateTime" style="position: relative; left: -22rpx; top: 0rpx">
        <text style="position: relative; left: 0rpx; top: 0rpx">æ—¶é—´</text>
        <text class="sort-icon">{{sortBy === 'updateTime' ? (sortAsc ? 'â†‘' : 'â†“') : ''}}</text>
      </view>
      <view class="sort-btn {{sortBy === 'importance' ? 'active' : ''}}" bindtap="toggleSort" data-type="importance" style="position: relative; left: 41rpx; top: 0rpx">
        <text style="position: relative; left: 4rpx; top: 0rpx">é‡è¦æ€§</text>
        <text class="sort-icon">{{sortBy === 'importance' ? (sortAsc ? 'â†‘' : 'â†“') : ''}}</text>
      </view>
    </view>
  </view>

  <!-- Todo list -->
  <view class="todo-list">
    <view wx:if="{{loading}}" class="loading-state">
      <text>åŠ è½½ä¸­...</text>
    </view>
    <view wx:elif="{{!todos.length}}" class="empty-state">
      <text>è¿˜æ²¡æœ‰æ—¥ç¨‹ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </text>
    </view>
    <view wx:for="{{todos}}" wx:key="_id" class="todo-card {{item.completed ? 'completed' : ''}}" bindtap="showEditModal" data-todo="{{item}}">
      <view class="todo-checkbox" bindtap="toggleComplete" data-id="{{item._id}}" data-completed="{{item.completed}}" catchtap>
        <icon type="{{item.completed ? 'success' : 'circle'}}" size="20" color="{{item.completed ? '#ff6b6b' : '#888'}}"></icon>
      </view>
      <view class="todo-content">
        <view class="todo-header">
          <view class="todo-title {{item.completed ? 'completed-text' : ''}}">{{item.title}}</view>
          <view class="todo-category" wx:if="{{item.category}}">{{item.category}}</view>
        </view>
        <view class="todo-description {{item.completed ? 'completed-text' : ''}}" wx:if="{{item.description}}">{{item.description}}</view>
        <view class="todo-meta">
          <view class="todo-time">{{item.updateTime ? 'æ›´æ–°äº: ' : 'åˆ›å»ºäº: '}}{{item.updateTime || item.createTime}}</view>
          <view class="todo-info-row">
            <view class="todo-importance">
              <text>é‡è¦åº¦:</text>
              <view class="importance-dots">
                <view wx:for="{{5}}" wx:for-index="idx" wx:for-item="dot" wx:key="idx" 
                  class="importance-dot {{idx < item.importance ? 'active' : ''}}"></view>
              </view>
            </view>
          </view>
        </view>
      </view>
      <view class="todo-actions">
        <view class="todo-action tomato-start-btn" bindtap="startTomato" data-id="{{item._id}}" catchtap>
          <icon type="waiting" size="16" color="#a084e8"></icon>
          <text>å¼€å§‹ç•ªèŒ„é’Ÿ</text>
        </view>
        <view class="todo-action delete-btn" bindtap="deleteTodo" data-id="{{item._id}}" catchtap>
          <icon type="cancel" size="20" color="#ff6b6b"></icon>
        </view>
      </view>
      
      <!-- ç•ªèŒ„é’Ÿå®Œæˆæ¬¡æ•°æ˜¾ç¤ºåœ¨å³ä¸‹è§’ -->
      <view class="tomato-counter" wx:if="{{item.tomatoCount > 0 || item.tomatoTotalTime > 0}}">
        <text class="tomato-emoji">ğŸ…</text>
        <text class="tomato-count-text">{{item.tomatoCount || 0}}</text>
        <text class="tomato-time-text" wx:if="{{item.tomatoTotalTime > 0}}">{{item.tomatoTotalTime}}åˆ†é’Ÿ</text>
      </view>
    </view>
  </view>

  <!-- Add button -->
  <view class="add-btn" bindtap="showAddModal">
    <text>+</text>
  </view>

  <!-- Add todo modal -->
  <view class="modal-mask" wx:if="{{showAddModal}}" bindtap="hideAddModal"></view>
  <view class="modal" wx:if="{{showAddModal}}">
    <view class="modal-header">
      <text>æ·»åŠ æ–°æ—¥ç¨‹</text>
    </view>
    <view class="modal-body">
      <view class="input-group">
        <text class="input-label">æ ‡é¢˜</text>
        <input class="input" placeholder="è¾“å…¥æ ‡é¢˜" value="{{newTodo.title}}" bindinput="onTitleInput" />
      </view>
      <view class="input-group">
        <text class="input-label">æè¿°</text>
        <textarea class="textarea" placeholder="è¾“å…¥æè¿°ï¼ˆå¯é€‰ï¼‰" value="{{newTodo.description}}" bindinput="onDescriptionInput"></textarea>
      </view>
      <view class="input-group">
        <text class="input-label">é‡è¦ç¨‹åº¦</text>
        <view class="importance-selector">
          <view 
            wx:for="{{5}}" 
            wx:key="index" 
            class="importance-option {{newTodo.importance >= index+1 ? 'active' : ''}}"
            bindtap="changeImportance"
            data-level="{{index+1}}">
            {{index+1}}
          </view>
        </view>
      </view>
      <view class="input-group">
        <text class="input-label">ç±»åˆ«</text>
        <picker range="{{categories}}" value="{{categories.indexOf(newTodo.category)}}" bindchange="onCategoryChange" class="category-picker">
          <view class="picker-content">
            <text>{{newTodo.category}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>
      <view class="input-group">
        <text class="input-label">ç•ªèŒ„é’Ÿæ—¶é•¿ (åˆ†é’Ÿ)</text>
        <input type="number" class="input" value="{{newTodo.tomatoDuration}}" bindinput="onTomatoDurationInput" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn cancel-btn" bindtap="hideAddModal">å–æ¶ˆ</button>
      <button class="btn confirm-btn" bindtap="saveTodo">ä¿å­˜</button>
    </view>
  </view>

  <!-- Edit todo modal -->
  <view class="modal-mask" wx:if="{{showEditModal}}" bindtap="hideEditModal"></view>
  <view class="modal" wx:if="{{showEditModal}}">
    <view class="modal-header">
      <text>ç¼–è¾‘æ—¥ç¨‹</text>
    </view>
    <view class="modal-body">
      <view class="input-group">
        <text class="input-label">æ ‡é¢˜</text>
        <input class="input" placeholder="è¾“å…¥æ ‡é¢˜" value="{{editingTodo.title}}" bindinput="onEditTitleInput" />
      </view>
      <view class="input-group">
        <text class="input-label">æè¿°</text>
        <textarea class="textarea" placeholder="è¾“å…¥æè¿°ï¼ˆå¯é€‰ï¼‰" value="{{editingTodo.description}}" bindinput="onEditDescriptionInput"></textarea>
      </view>
      <view class="input-group">
        <text class="input-label">é‡è¦ç¨‹åº¦</text>
        <view class="importance-selector">
          <view 
            wx:for="{{5}}" 
            wx:key="index" 
            class="importance-option {{editingTodo.importance >= index+1 ? 'active' : ''}}"
            bindtap="changeEditImportance"
            data-level="{{index+1}}">
            {{index+1}}
          </view>
        </view>
      </view>
      <view class="input-group">
        <text class="input-label">ç±»åˆ«</text>
        <picker range="{{categories}}" value="{{categories.indexOf(editingTodo.category)}}" bindchange="onEditCategoryChange" class="category-picker">
          <view class="picker-content">
            <text>{{editingTodo.category}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>
      <view class="input-group">
        <text class="input-label">ç•ªèŒ„é’Ÿæ—¶é•¿ (åˆ†é’Ÿ)</text>
        <input type="number" class="input" value="{{editingTodo.tomatoDuration}}" bindinput="onEditTomatoDurationInput" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn cancel-btn" bindtap="hideEditModal">å–æ¶ˆ</button>
      <button class="btn confirm-btn" bindtap="updateTodo">ä¿å­˜</button>
    </view>
  </view>

  <!-- ç•ªèŒ„é’Ÿè®¡æ—¶æ¡ -->
  <view class="tomato-timer-bar {{showTomatoBar ? 'show' : ''}}" wx:if="{{tomatoTimer}}">
    <view class="tomato-timer-info">
      <view class="tomato-timer-text">ğŸ… {{formatTomatoTime(tomatoTimeLeft)}}</view>
    </view>
    <view class="tomato-timer-actions">
      <view class="tomato-timer-btn stop-btn" bindtap="stopTomato">ç»“æŸ</view>
    </view>
  </view>
</view> 